# Руководство

## Тезаурус

**Платформой** называется сочетание из *хоста* и набора *устройств*, управляемых *фреймворком OpenCL*, позволяющим приложению разделять ресурсы и выполнять *ядра* на *устройствах* в этой платформе.

**Устройство** — это набор вычислительных блоков. Используется очередь команд для добавления в порядке FIFO команд для их выполнения устройством. Примерами служат команды для выполнения *ядер*, чтение/запись над *объектами памяти*.

**Ядром** является функция, определенная в *программе* и исполняемая на устройстве. Ядро отличается от других функций спецификатором `__kernel`.

**Программа** — программа, написанная на языке OpenCL C (специальном расширении языка C99), включающая множество ядер. Программа может содержать вспомогательные функции, вызываемые `__kernel` функциями, а также неизменяемые данные.

**Фреймворк** — это система программного обеспечения, содержащая набор компонентов для поддержки разработки ПО и его выполнения. Фреймворк обычно включает библиотеки, программные интерфейсы приложения (APIs), системы времени исполнения, компиляторы и т.д.

**Хост** — это та часть гетерогенной системы, которая взаимодействует с *контекстом* через OpenCL API.

**Контекст** — это окружение, в котором выполняются ядра, и область, внутри которой определены синхронизация и управление памятью. Контекст включает множество устройств, память (доступную этим устройствам), соответствующие свойства памяти и одна или более очередей команд, используемых для планирования выполнения одного или нескольких ядер или операций над *объектами памяти*.

**Объект памяти** — это описатель глобальной области памяти с подсчетом ссылок (после обнуления счетчика память разрешено освободить).

## Подготовка

В каталоге D:\Student\ocl_labs расположены предкомпилированные OpenCL ядра и  все необходимые исходные коды. Структура директории:
* CmakeLists.txt — файл для автоматизации сборки;
* toolchain.cmake — файл с указанием сведений о целевой платформе и используемых компиляторах;
* common/ — исходные коды, используемые в разных работах;
* kernels/ — содержит предкомпилированные ядра;
* lab*/ — каталоги одноименных работ.

Потребуется трансляция программ работ, поэтому запустите bash (Win+R -> bash) и выполните команды ниже для инициализации CMake:

```shell
$ cd /d/Student/ocl_labs/
$ mkdir build && cd build # здесь создаем *каталог сборки*
$ cmake .. -G "MSYS Makefiles" -DCMAKE_TOOLCHAIN_FILE="../toolchain.cmake"
```

В директории build сгенерируется Makefile, с помощью которого будут собираться программы работ.

Убедитесь, что на обратной стороне отладочной платы DE1-SOC переключатели MSEL[4:0] выставлены в положении «01010» — это означает, что ПЛИС будет конфигурироваться аппаратной процессорной системой на базе ARM-процессора.

[picture]

Для переноса  исполняемых файлов на отладочный комплекс понадобится USB флеш накопитель. На нем рекомендуется создать директорию ocl_labs, где будут размещаться исполняемые файлы.

## Получение сведений о платформе и устройствах

Программа в каталоге lab0 выводит сведения о платформе и всех ее устройствах, доступных для OpenCL. Платформа похожа на драйвер тем, что предоставляет поддерживаемые устройства для использования посредством OpenCL Runtime API. Так, например, в одном ПК может быть платформа от AMD для одной видеокарты и одного процессора, а также платформа от nVIDIA для второй видеокарты.

Первая демонстрационная программа состоит только из хостовой части. Для сборки выполните `make lab0`, находясь в каталоге сборки build. В build/lab0/ будет соответствующий исполняемый файл. Не обращайте внимание на предупреждение компилятора об отсутствии динамической библиотеки.

Для запуска lab0 выполните следующие шаги:

1. Подключите плату к компьютеру через UART-to-USB разъем.
2. Запустите «Диспетчер устройств» (например, с помощью Win+R, введя имя devmgmt.msc). В категории «Порты (COM и LPT) найдите «USB Serial Port (COMn)», где n – номер устройства.

[picture]

3. Откройте PuTTY, выберете последовательный тип подключения, укажите название устройства (в данном случае — COM7) и скорость — 115200. Откройте соединение с помощью кнопки «Open» (в появившейся консоли пока ничего нет).

[picture]

4. Подключите к плате питание и нажмите на кнопку включения. В окне с открытой сессией терминального доступа будет выводиться информация о ходе загрузки системы.
5. Когда появится приглашение, выполните вход под пользователем root (пароль не установлен).
6. Выполните `source ./init_opencl.sh`, чтобы загрузить драйвер OpenCL и установить переменные среды окружения для предустановленной библиотеки времени исполнения OpenCL.
7. Загрузите на USB накопитель исполняемый файл lab0. Подключите его к плате и смонтируйте, например, так:

```shell
$ mkdir /mnt/usb
$ lsblk # узнайте название устройства, пусть оно будет sda1
$ mount /dev/sda1 /mnt/usb
$ #umount /mnt/usb #для размонтирования, при этом нельзя находиться на носителе
```
**Замечание**: рекомендуется прописать следующие псевдонимы:

```
